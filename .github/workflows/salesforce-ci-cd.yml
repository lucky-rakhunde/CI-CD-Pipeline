# .github/workflows/salesforce-run-tests.yml
name: Salesforce - Run Apex Tests Only

on:
  workflow_dispatch:           # Manual trigger from GitHub UI (best for beginners/testing)
  schedule:
    - cron: '0 0 * * *'        # Optional: every day at midnight UTC (adjust as needed)
  pull_request:                # Optional: run on PRs if you want
    branches: [main, uat]

jobs:
  run-apex-tests:
    runs-on: ubuntu-latest

    # Use environment for secret isolation (create 'sandbox' or 'test' env in repo settings)
    environment: sandbox       # â† Change to your env name (sandbox/uat/etc.)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install latest Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate with JWT
        run: |
          # Write private key from secret
          echo "${{ secrets.SF_JWT_KEY }}" > server.key

          # Modern login command
          sf org login jwt \
            --client-id ${{ secrets.SF_CONSUMER_KEY }} \
            --jwt-key-file server.key \
            --username ${{ secrets.SF_USERNAME }} \
            --instance-url ${{ secrets.SALESFORCE_INSTANCE_URL }} \
            --alias test-org

          # Quick auth check
          sf org display --target-org test-org

      - name: Run All Apex Tests with Code Coverage
        run: |
          # Runs ALL local tests + shows code coverage + waits up to 30 min
          sf apex test run \
            --target-org test-org \
            --code-coverage \
            --result-format human \
            --wait 30

          # Optional: If you want JUnit format for CI reporting (GitHub shows nice summary)
          # sf apex test run --target-org test-org --code-coverage --result-format junit --wait 30 > test-results.xml

      - name: Cleanup sensitive files
        if: always()
        run: rm -f server.key
